# 목차

# 5. 고급 주제와 성능 최적화

## 5.1 예외 처리

JPA 표준 예외들은 모두 _javax.persistence.PersistenceException_ 의 자식 클래스이다.
해당 예외는 _RuntimeException_ 을 상속한다. 따라서 JPA 예외는 모두 언체크 예외다.

### 5.1.1 JPA 표준 예외 정리

**JPA 표준 예외 종류**
- 트랜잭션 롤백을 표시하는 예외
- 트랜잭션 롤백을 표시하지 않는 예외

트랜잭션 롤백을 표시하는 예외는 심각한 예외이므로 복구해선 안 된다. 반면 후자는 심각한 예외는 아니므로 개발자가 커밋할 지 복구할 지 선택하면 된다.

### 5.1.2 스프링 프레임워크의 JPA 예외 변환

서비스 계층이 DAO 계층의 구현 기술에 종속적이라면 좋은 설계라고 할 수 없다.
이것은 예외도 마찬가지인데, 스프링은 DAO 계층에 대한 예외를 추상화해서 개발자에게 제공한다.

예를 들어 _PersistenceException_ 은 스프링에 의해 _JpaSystemException_ 으로 변환된다.

### 5.1.3 스프링 프레임워크에 JPA 예외 변환기 적용

JPA 예외를 스프링이 제공하는 추상화된 예외로 변경하려면 _PersistenceExceptionTranslationPostProcessor_ 를 스프링 빈으로 등록하면 된다.

이것은 _@Repository_ 어노테이션을 사용한 곳에 **예외 변환 AOP**를 적용해서 JPA 예외를 스프링이 추상화된 예외로 변환해준다.

> **설정 방법: XML**

```xml
<bean class="org.springframework.dao.annotation.PersistenceExceptionTranslationPostProcessor" />
```


> **설정 방법: JavaConfig**
```java
@Bean
public PersistenceExceptionTranslationPostProcessor exceptionTranslation() {
    return new PersistenceExceptionTranslationPostProcessor();
}
```

### 5.1.4 트랜잭션 롤백 시 주의사항

- 트랜잭션을 롤백하는 것은 데이터베이스 반영사항만 롤백하는 것이지 수정한 자바 객체는 원상복구해주지 않는다.
- 엔티티를 조회 후 수정했을 때 롤백이 발생하면 데이터베이스는 원상복구 되지만 수정된 객체는 영속성 컨텍스트에 계속해서 남아있다.
- 이런 경우 새로운 영속성 컨텍스트를 사용하거나 `EntityManager.clear()`를 이용해서 영속성 컨텍스트를 초기화해야 한다.

스프링은 이런 문제를 해결하기 위해 영속성 컨텍스트의 범위에 따라 다른 방법을 사용한다.

> **기본 전략: 트랜잭션 당 하나의 영속성 컨텍스트**

트랜잭션 AOP 종료 시점에 트랜잭션을 롤백하면서 영속성 컨텍스트도 함께 종료한다.

> **영속성 컨텍스트의 범위를 트랜잭션보다 넓게 사용할 때**

트랜잭션 롤백시 영속성 컨텍스트를 초기화해서 잘못된 영속성 컨텍스트를 사용하는 문제를 해결한다.

## 5.2 엔티티 비교

영속성 컨텍스트 내부에는 엔티티 인스턴스를 보관하기 위한 1차 캐시가 있다.
1차 캐시로 인해 변경 감지 기능도 동작하고, 데이터베이스를 통하지 않고 바로 레코드 조회가 가능하다.

하지만 1차 캐시의 또 다른 큰 장점은 **동등성** 을 보장한다는 점이다. JPA는 같은 영속성 컨텍스트에서 엔티티를 조회하면 항상 같은 엔티티를 반환해준다.

### 5.2.1 영속성 컨텍스트가 같을 때 엔티티 비교

![](002.png);

### 5.2.2 영속성 컨텍스트가 다를 때 엔티티 비교

## 5.3 프록시 심화 주제

### 5.3.1 영속성 컨텍스트와 프록시

### 5.3.2 프록시 타입 비교

### 5.3.3 프록시 동등성 비교

### 5.3.4 상속관계와 프록시

## 5.4 성능 최적화

### 5.4.1 N+1 문제

### 5.4.2 읽기 전용 쿼리의 성능 최적화

### 5.4.3 배치 처리

### 5.4.4 SQL 쿼리 힌트 사용

### 5.4.5 트랜잭션을 지원하는 쓰기 지연과 성능 최적화

