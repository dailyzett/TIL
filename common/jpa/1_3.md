# 목차

# 3. 연관관계 매핑

엔티티 연관관계를 매핑할 때는 세 가지를 고려해야 한다.

- 다중성
- 단방향, 양방향
- 연관관계의 주인

> **다중성**

- 다대일(@ManyToOne)
- 일대다(@OneToMany)
- 일대일(@OneToOne)
- 다대다(@ManyToMany)

> **단방향, 양방향**

- 테이블은 외래키 하나로 양 테이블을 참조할 수 있기 때문에 방향성이 없다.
- 하지만 객체는 참조용 필드를 가지고 있는 객체만 연관된 객체를 조회할 수 있기 때문에 방향성이 존재한다.

> **연관 관계의 주인**

- 데이터베이스에서 외래키를 관계하는 테이블은 하나다.
- 객체에서 엔티티를 양방향 매핑하면 두 곳에서 서로를 참조하므로 관리하는 포인트는 두 곳이다.

즉, 불일치를 해결하기 위해 JPA는 두 객체 중 하나를 정해서 외래키를 관리하도록 만든다.
**외래키를 가진 테이블과 매핑한 엔티티가 외래키를 관리하는 게 효율적이므로 보통 이곳을 연관관계의 주인으로 선택한다.**

연관 관계의 주인은 _mappedBy_ 속성을 사용하지 않는다.

## 3.1 다대일

객체 양방향 관계에서 연관관계의 주인은 항상 다쪽이다. 외래키는 항상 다쪽에서 관리하기 때문이다.

### 3.1.1 다대일 단방향

<div align="center">
<img src="img_6.png" width="70%">
</div>

### 3.1.2 다대일 양방향

- 객체 연관관계에서 실선이 연관관계의 주인.
- 점선은 연관관계의 주인이 아니다.

<div align="center">
<img src="img_7.png" width="70%">
</div>

양방향 연관관계는 항상 서로를 참조해야 된다. 한쪽만 참조한 상태라면 JPA를 사용하지 않는 순수 테스트 코드에서 객체 그래프 탐색 시 NULL 을 반환할 수 있기 때문이다.

```java

@Entity
public class Member {

	//...

	@ManyToOne
	@JoinColumn(name = "TEAM_ID")
	private Team team;

	//연관관계 편의 메서드
	public void setTeam(Team team) {
		this.team = team;

		//무한루프 체크
		if (!team.getMembers().contains(this)) {
			team.getMembers().add(this);
		}
	}
}
```

```java

@Entity
public class Team {

	//...

	@OneToMany(mappedBy = "team")
	private List<Member> members = new ArrayList<>();

	public void addMember(Member member) {
		this.members.add(member);

		//무한 루프 체크
		if (member.getTeam() != this) {
			member.setTeam(this);
		}
	}
}

```

- 연관관계 편의 메서드는 한 곳에만 작성하거나 양쪽 다 작성 가능하다.
- 양쪽 작성 시 무한루프에 빠지므로 무한 루프 체크가 반드시 필요하다.

> **Note.**  
> 예를 들어 Member.toString()에서 getTeam()을 호출하고 Team.toString()에서 getMember()를 호출하면
> 무한 루프에 빠진다. 이런 문제는 JSON으로 변환할 때 자주 발생하는데 JSON 라이브러리들은 무한 루프에 빠지지
> 않도록 어노테이션 기능을 제공한다. 그리고 Lombok 라이브러리를 사용할 때도 자주 발생한다.

### 3.1.3 일대다 단방향

<div align="center">
<img src="img_8.png" width="70%">
</div>


